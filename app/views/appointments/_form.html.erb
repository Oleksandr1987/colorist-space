<div class="appointment-container">
  <div class="appointment-header">
    <%= link_to "←", appointments_path, class: "back-link inline" %>
    <h2>
      <%= @appointment.new_record? ?
            t("appointments.new") :
            t("appointments.edit") %>
    </h2>
  </div>

  <%= form_with model: @appointment, local: true, data: { controller: "calendar appointment" } do |f| %>

    <% if @appointment.errors.any? %>
      <div class="error-messages">
        <h4>
          <%= pluralize(@appointment.errors.count, "error") %>
          prevented the appointment from being saved:
        </h4>
        <ul>
          <% @appointment.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Client Name -->
    <div class="form-section">
      <label>
        <%= t("appointments.form.client_name") %>
        <span class="required-asterisk">*</span>
      </label>

      <%= text_field_tag "appointment[client_name]",
        @appointment.client&.full_name || "",
        class: "form-input",
        placeholder: t("appointments.form.client_name_placeholder"),
        data: {
          "calendar-target": "clientName",
          action: "input->calendar#updateClientInfo"
        },
        list: "client-list",
        autocomplete: "off" %>

      <datalist id="client-list" data-calendar-target="clientList">
        <% current_user.clients.each do |client| %>
          <option value="<%= client.full_name %>" data-phone="<%= client.phone %>">
        <% end %>
      </datalist>
    </div>

    <!-- Phone -->
    <div class="form-section">
      <label>
        <%= t("appointments.form.phone") %>
        <span class="required-asterisk">*</span>
      </label>

      <%= telephone_field_tag "appointment[phone]",
        @appointment.client&.phone || "",
        class: "form-input",
        data: { "calendar-target": "clientPhone" } %>
    </div>

    <!-- Date -->
    <div class="form-section">
      <label>
        <%= t("appointments.form.date") %>
        <span class="required-asterisk">*</span>
      </label>

      <%= text_field_tag "appointment[appointment_date]",
        (@appointment.appointment_date || Date.today).strftime("%d.%m.%Y"),
        class: "form-input",
        readonly: true,
        id: "appointment_date",
        data: {
          controller: "datepicker",
          datepicker_target: "input",
          min: Date.today.strftime("%Y-%m-%d")
        } %>
    </div>

    <!-- Start / End Time -->
    <div class="form-section double">
      <div>
        <%= f.label :appointment_time, t("appointments.form.start_time") %>
        <span class="required-asterisk">*</span>
        <%= f.time_field :appointment_time,
          step: 300,
          class: "form-input",
          data: {
            controller: "appointment",
            action: "blur->appointment#roundToNearestFive"
          } %>
      </div>

      <div>
        <%= f.label :end_time, t("appointments.form.end_time") %>
        <span class="required-asterisk">*</span>
        <%= f.time_field :end_time,
          step: 300,
          class: "form-input",
          data: {
            controller: "appointment",
            action: "blur->appointment#roundToNearestFive"
          } %>
      </div>
    </div>

    <!-- Main Services -->
    <div class="form-section">
      <label>
        <%= t("appointments.form.services") %>
        <span class="required-asterisk">*</span>
      </label>
      <div class="fake-input"
           data-action="click->appointment#open"
           data-type="service">
        <span data-appointment-target="serviceSelected"
              class="placeholder">
          <%= t("appointments.form.select_services") %>
        </span>
      </div>
    </div>

    <!-- Preparations -->
    <div class="form-section">
      <label><%= t("appointments.form.preparations") %></label>
      <div class="fake-input"
           data-action="click->appointment#open"
           data-type="preparation">
        <span data-appointment-target="preparationSelected"
              class="placeholder">
          <%= t("appointments.form.select_preparations") %>
        </span>
      </div>
    </div>

    <!-- Care Products -->
    <div class="form-section">
      <label><%= t("appointments.form.care_products") %></label>
      <div class="fake-input"
           data-action="click->appointment#open"
           data-type="care_product">
        <span data-appointment-target="careProductSelected"
              class="placeholder">
          <%= t("appointments.form.select_care_products") %>
        </span>
      </div>
    </div>

    <!-- Hidden combined IDs -->
    <input type="hidden"
           data-appointment-target="hiddenInput"
           value="<%= @appointment.service_ids.join(',') %>">

    <!-- Notes -->
    <div class="form-section">
      <%= f.label :notes, t("appointments.form.notes") %>
      <%= f.text_area :notes,
        class: "form-input textarea-auto",
        maxlength: 256,
        rows: 2,
        placeholder: t("appointments.form.notes_placeholder") %>
    </div>

    <!-- Total -->
    <div class="total-price">
      <strong><%= t("appointments.form.total") %>:</strong>
      <span data-appointment-target="total">0</span> ₴
    </div>

    <!-- Submit -->
    <div class="form-actions" style="height: 80px;"></div>
    <%= f.submit t("appointments.form.save"), class: "floating-save-button" %>

    <!-- Modals -->
    <%= render "appointments/modals/service_modal" %>
    <%= render "appointments/modals/preparation_modal" %>
    <%= render "appointments/modals/care_product_modal" %>
  <% end %>
</div>
