<div data-controller="client-profile photo" class="client-profile-container">
  <!-- Header -->
  <div class="client-header">
    <div>
      <h1><%= @client.full_name %></h1>
    </div>

    <div data-controller="menu" class="menu-wrapper">
      <button class="vertical-menu-toggle" data-action="click->menu#toggleMenu">‚â°</button>
      <div data-menu-target="menu" class="menu hidden">
        <%= link_to "New Appointment", new_appointment_path(client_id: @client.id), class: "menu-item"%>
        <%= link_to "Edit Client", edit_client_path(@client), class:  "menu-item"%>
        <a href="#client-info" class="menu-item" data-action="click->client-profile#toggleInfo">Info</a>
        <%= button_to "Delete Client", client_path(@client),
                      method: :delete,
                      data: { turbo_confirm: "Are you sure you want to delete this client and all their appointments?" },
                      class: "menu-item delete" %>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-button active"
            data-client-profile-target="tab"
            data-tab-name="styles"
            data-action="click->client-profile#showTab">
      Styles
    </button>
    <button class="tab-button"
            data-client-profile-target="tab"
            data-tab-name="photos"
            data-action="click->client-profile#showTab">
      Photos
    </button>
  </div>

  <!-- Styles Tab -->
  <div id="styles-tab" data-client-profile-target="tabContent" class="tab-content active">
    <% @client.service_notes.order(created_at: :desc).group_by { |note| note.created_at.to_date }.each do |date, notes| %>
      <div class="style-group">
        <h3><%= date.strftime('%B %d') %></h3>
        <div class="photos-grid">
          <% notes.each do |note| %>
            <div class="service-note-thumb">
              <%= link_to client_service_note_path(@client, note) do %>
                <% if note.photos.attached? %>
                  <%= image_tag note.photos.first, class: "client-photo" %>
                <% else %>
                  <div class="no-photo">No photo</div>
                <% end %>
              <% end %>

              <div class="note-actions">
                <%= link_to edit_client_service_note_path(@client, note), class: "edit-icon" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" class="lucide lucide-pencil" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 2a2.828 2.828 0 1 1 4 4L7 21l-4 1 1-4Z" />
                    <path d="M16 5l3 3" />
                  </svg>
                <% end %>

                <div data-controller="popover" class="popover">
                  <button class="popover-toggle" data-action="click->popover#toggle">
                    ‚ãÆ
                  </button>
                  <div class="popover-menu hidden" data-popover-target="menu">
                    <%= button_to client_service_note_path(@client, note),
                          method: :delete,
                          data: { turbo_confirm: "Delete this note?" },
                          class: "popover-item delete-button" do %>
                      Delete this style
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Photos Tab -->
  <div id="photos-tab" data-client-profile-target="tabContent" class="tab-content hidden">
    <div class="photos-grid">
      <% @client.photos.each do |photo| %>
        <div class="photo-wrapper" data-action="click->photo#show touchstart->photo#touchStart touchend->photo#touchEnd">
          <%= image_tag photo, class: "client-photo", data: { photo_url: url_for(photo) } %>
          <%= button_to delete_photo_client_path(@client, photo.id),
                        method: :delete,
                        data: { turbo_confirm: "Delete this photo?" },
                        class: "photo-delete-btn" do %>
            üóë
          <% end %>
        </div>
      <% end %>
    </div>

    <% if @client.photos.attached? %>
      <%= button_to delete_all_photos_client_path(@client),
                    method: :delete,
                    data: { turbo_confirm: "Delete ALL photos?" },
                    class: "button delete-all" do %>
        Delete All Photos
      <% end %>
    <% end %>
  </div>

  <!-- Client Info Section -->
  <div id="client-info" data-client-profile-target="info" class="client-info hidden">
    <p><strong>Phone:</strong> <%= @client.phone %></p>
    <p><strong>Hair Type:</strong> <%= @client.hair_type %></p>
    <p><strong>Hair Length:</strong> <%= @client.hair_length %></p>
    <p><strong>Hair Structure:</strong> <%= @client.hair_structure %></p>
    <p><strong>Hair Density:</strong> <%= @client.hair_density %></p>
    <p><strong>Scalp Condition:</strong> <%= @client.scalp_condition %></p>
    <p><strong>Note:</strong> <%= @client.note %></p>
  </div>

  <!-- Action Buttons -->
  <div class="actions">
    <%= link_to "Back", clients_path, class: "button secondary" %>
  </div>

  <!-- Modal for photo viewer -->
  <div data-photo-target="modal" class="modal hidden">
    <button class="carousel-button left" data-action="click->photo#prev">‚Üê</button>
    <img data-photo-target="modalImage" class="modal-img" />
    <button class="carousel-button right" data-action="click->photo#next">‚Üí</button>
    <button class="carousel-close" data-action="click->photo#close">‚úï</button>
  </div>
</div>
