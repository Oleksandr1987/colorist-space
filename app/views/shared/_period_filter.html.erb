<div class="period-filter sticky-period-filter">
  <% from_date = Date.parse(permitted_params[:from]) rescue nil %>
  <% to_date = Date.parse(permitted_params[:to]) rescue nil %>

  <% period_label = t("analytics.period_filter.period") %>

  <% if from_date && to_date %>
    <% days_diff = (to_date - from_date).to_i %>

    <% preset_map = {
      7 => t("analytics.period_filter.presets.d7"),
      14 => t("analytics.period_filter.presets.d14"),
      30 => t("analytics.period_filter.presets.m1"),
      90 => t("analytics.period_filter.presets.m3"),
      180 => t("analytics.period_filter.presets.m6"),
      270 => t("analytics.period_filter.presets.m9"),
      365 => t("analytics.period_filter.presets.y1")
    } %>

    <% period_label = preset_map[days_diff] ||
      "#{from_date.strftime('%d.%m.%Y')} - #{to_date.strftime('%d.%m.%Y')}" %>
  <% end %>

  <div class="quick-filters">

    <!-- PERIOD DROPDOWN -->
    <div class="dropdown" data-controller="dropdown">
      <button class="filter-button <%= 'active' if from_date && to_date %>" data-action="click->dropdown#toggle">
        <%= period_label %>
      </button>
      <div class="dropdown-menu hidden" data-dropdown-target="menu">
        <% [
          [t("analytics.period_filter.presets.d7"), 7],
          [t("analytics.period_filter.presets.d14"), 14],
          [t("analytics.period_filter.presets.m1"), 30],
          [t("analytics.period_filter.presets.m3"), 90],
          [t("analytics.period_filter.presets.m6"), 180],
          [t("analytics.period_filter.presets.m9"), 270],
          [t("analytics.period_filter.presets.y1"), 365]
        ].each do |label, days| %>
          <% from_val = days.days.ago.to_date.to_s %>
          <% to_val = Date.today.to_s %>
          <%= link_to label,
              url_for(permitted_params.merge(from: from_val, to: to_val)),
              class: "dropdown-item" %>
        <% end %>
      </div>
    </div>

    <!-- CATEGORY FILTER -->
    <% show_category = local_assigns[:show_category] != false %>
    <% if show_category %>
      <div class="dropdown" data-controller="dropdown">
        <button class="filter-button <%= 'active' if permitted_params[:category].present? %>"
                data-action="click->dropdown#toggle">
          <%= permitted_params[:category].presence || t("analytics.period_filter.categories.category") %>
        </button>
        <div class="dropdown-menu hidden" data-dropdown-target="menu">
          <%= link_to t("analytics.period_filter.categories.all"),
                expenses_analytics_path(from: permitted_params[:from], to: permitted_params[:to]),
                class: "dropdown-item" %>

          <% Expense::CATEGORIES.each do |cat| %>
            <%= link_to cat,
                expenses_analytics_path(from: permitted_params[:from], to: permitted_params[:to], category: cat),
                class: "dropdown-item" %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- CUSTOM RANGE -->
  <div class="custom-range">
    <%= form_with url: request.path, method: :get, local: true do %>
      <div class="custom-range">
        <div class="form-section">
          <%= label_tag :from, t("analytics.period_filter.from"), class: "form-label" %>
          <%= text_field_tag :from, permitted_params[:from],
                class: "form-input small",
                required: true,
                data: { controller: "datepicker", datepicker_target: "input" } %>
        </div>

        <div class="form-section">
          <%= label_tag :to, t("analytics.period_filter.to"), class: "form-label" %>
          <%= text_field_tag :to, permitted_params[:to],
                class: "form-input small",
                required: true,
                data: { controller: "datepicker", datepicker_target: "input" } %>
        </div>
      </div>

      <div class="form-section">
        <%= submit_tag t("analytics.period_filter.apply"), class: "form-button primary full-width" %>
      </div>
    <% end %>
  </div>
</div>
