<div class="analytics-header-bar">
  <%= link_to "←", expenses_analytics_path(from: params[:from], to: params[:to]), class: "back-button-inline", title: "Назад" %>

  <h1>Аналітика: Витрати</h1>

  <%= link_to new_expense_path, class: "add-expense-button", title: "Додати витрату" do %>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
         class="lucide lucide-plus">
      <path d="M5 12h14"/><path d="M12 5v14"/>
    </svg>
  <% end %>
</div>

<%= render 'shared/period_filter' %>

<% if params[:from].present? && params[:to].present? %>
  <% if @category_filter.present? %>
    <div class="expenses-category-header-aligned">
      <span class="category-header-title"><%= @category_filter %></span>
      <span class="category-header-amount"><%= @total_expenses %> ₴</span>
    </div>

    <div class="expenses-scroll-wrapper">
      <% @monthly_expenses.each do |month_name, expenses| %>
        <div class="monthly-expense-group" data-controller="collapse">
          <div class="month-header-aligned" data-action="click->collapse#toggle">
            <span class="month-header-title"><%= month_name %></span>
            <div class="month-header-right">
              <span class="month-header-amount"><%= expenses.sum(&:amount) %> ₴</span>
            </div>
          </div>

          <ul class="expenses-list collapsible hidden" data-collapse-target="content">
            <% expenses.sort_by(&:spent_on).reverse.each do |expense| %>
              <li class="expense-item" data-controller="popover">
                <div class="expense-info">
                  <%= expense.amount %> ₴ [<%= l(expense.spent_on, format: :default) %>]
                  <% if expense.note.present? %> — <%= expense.note %><% end %>
                </div>

                <div class="expense-actions">
                  <button class="popover-toggle" data-popover-target="button" data-action="click->popover#toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="lucide lucide-pencil" width="20" height="20"
                         viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                         stroke-linecap="round" stroke-linejoin="round">
                      <path d="M18 2a2.828 2.828 0 1 1 4 4L7 21l-4 1 1-4Z" />
                      <path d="M16 5l3 3" />
                    </svg>
                  </button>

                  <div class="popover-menu hidden" data-popover-target="menu">
                    <%= link_to "Edit", edit_expense_path(expense), class: "popover-item" %>
                    <%= button_to expense_path(expense), method: :delete,
                          data: { turbo_confirm: "Ви впевнені?" }, class: "popover-item delete-button" do %>
                      Delete
                    <% end %>
                  </div>
                </div>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>

  <% else %>
    <% total_all = @grouped_expenses.values.sum %>

    <div class="grouped-expense-list">
      <% @grouped_expenses.each do |category, sum| %>
        <div class="grouped-expense-block">
          <%= link_to expenses_analytics_path(category: category, from: params[:from], to: params[:to]),
                      class: "category-summary-link aligned" do %>
            <span class="category-name-text"><%= category %></span>
            <span class="category-amount"><%= sum %> ₴</span>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="grouped-expense-total">
      <span>Загалом за період:</span>
      <strong><%= total_all.to_i %> ₴</strong>
    </div>
  <% end %>
<% end %>
